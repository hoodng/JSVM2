self.js = self.js || {};(function () {var TYPES = ["Null", "Undefined", "Function", "Object", "Array", "Boolean", "Number", "String", "Date"], lang = js.lang = {Class:function () {}}, Class = lang.Class, Func = Function.prototype, SANDBOX = Class.SANDBOX = {name:"j$vm-sandbox"}, BREAKLOOP = Class.BREAKLOOP = "break-loop", sliceArgs = Array.prototype.slice, typeString = Object.prototype.toString, hasKey = Object.prototype.hasOwnProperty;(function () {var REGX_TRIM = /(^\s*)|(\s*$)/g;this.trim = this.trim || function () {return this.toString().replace(REGX_TRIM, "");};this.startsWith = this.startsWith || function (s) {return this.indexOf(s) === 0;};this.endsWith = this.endsWith || function (s) {return this.indexOf(s, this.length - s.length) !== -1;};}).call(String.prototype);Class.typeOf = function (x, type) {var s = typeString.call(x);s = s.substring(8, s.length - 1);return arguments.length > 1 ? s === type : s;};Class.sliceArgs = function (args, n) {return sliceArgs.call(args, n || 0);};Class.hasKey = function (obj, key) {return hasKey.call(obj, key);};Class.keysOf = function (obj) {var keys = [];(function (v, k) {keys.push(k);}).$forEach(obj);return keys;};Class.entrySet = function (obj) {var keys = [];(function (v, k) {keys.push({key:k, value:v});}).$forEach(obj);return keys;};Math.forArray = function (set, fn, thi$, args) {thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);for (var i = 0, len = set.length; i < len; i++) {try {fn.apply(thi$, [set[i], i, set].concat(args));}catch (x) {if (x === BREAKLOOP) {break;}throw x;}}};Math.forObject = function (set, fn, thi$, args) {thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);for (var i in set) {if (!hasKey.call(set, i)) {continue;}try {fn.apply(thi$, [set[i], i, set].concat(args));}catch (x) {if (x === BREAKLOOP) {break;}throw x;}}};Func.$forEach = function (set, thi$, args) {if (!set) {return;}Math[["for", null].join(Class.typeOf(set))].apply(SANDBOX, [set, this].concat(sliceArgs.call(arguments, 1)));};(function (type) {Class[["is", null].join(type)] = function (x) {return this.typeOf(x, type);};}).$forEach(TYPES);var last = (new Date()).getTime(), DIFF = (1 << 16) + (1 << 8) + 1;Math.hash = function (obj) {var now = obj ? obj.__hash__ : null;if (!now) {now = (new Date()).getTime();if (now <= last) {now = last + DIFF;}if (obj) {obj.__hash__ = now;}last = now;}return now;};Math.uuid = function (obj) {var id = obj ? obj.__uuid__ : null;if (!id) {id = [null, this.hash(obj).toString(16)].join("s");if (obj) {obj.__uuid__ = id;}}return id;};Func.$bind = function (thi$, args) {var fn = this;args = sliceArgs.call(arguments, 1);return function () {return fn.apply(thi$, sliceArgs.call(arguments).concat(args));};};Func.$override = function (fn) {this.__super__ = fn;return this;};self.$super = function (thi$, args) {var caller = self.$super.caller;args = arguments.length > 1 ? sliceArgs.call(arguments, 1) : sliceArgs.call(caller.arguments);return caller.__super__.apply(thi$, args);};var tTable = {};Func.$delay = function (timeout, thi$, args) {var fn = this, uuid = Math.uuid(fn), timer, ts = tTable[uuid] = (tTable[uuid] || []);thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 2);timer = self.setTimeout(function () {fn.$cancel(timer);fn.apply(thi$, args);}, timeout);ts.push(timer);return timer;};Func.$cancel = function (timer) {var fn = this, uuid = Math.uuid(fn), ts = tTable[uuid] = (tTable[uuid] || []);timer = arguments.length == 0 ? ts.shift() : timer;(function (t, i) {if (t === timer) {ts.splice(i, 1);throw BREAKLOOP;}}).$forEach(ts);if (ts.length === 0) {delete tTable[uuid];}};Func.$loop = function (testP, thi$, args) {var fn = this;thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);if (testP.apply(thi$, args)) {fn.apply(thi$, args);(function () {fn.$loop.apply(fn, [testP, thi$].concat(args));}).$delay(0);}};Func.$queue = function (callback, thi$, args) {_queue.apply(SANDBOX, [this].concat(sliceArgs.call(arguments)));};Func.$extend = function (clazz) {var proto;if (Class.isFunction(clazz)) {proto = new (clazz)();proto.constructor = clazz;} else {if (clazz) {proto = clazz;}}this.prototype = proto;return this;};Func.$decorate = function (obj, replace) {var clazz = this;if (!obj) {return null;}if (!clazz.__defined__) {new (clazz)();}replace = replace || {};(function (e, k) {if (Class.isFunction(e) && (!obj[k] || replace[k])) {obj[k] = e;}}).forEach(clazz.prototype);return obj;};Func.$implements = function (clazz) {var proto = this.prototype, impls;impls = proto.__impls__ = [].concat(proto.__impls__ || []);(function (fn) {if (Class.isFunction(fn)) {impls.push(fn);fn.$decorate(proto);}}).$forEach(sliceArgs.call(arguments));return this;};var tasks = [], running;var _queue = function (fn, callback, thi$, args) {var task = {state:0, fn:fn, data:null}, curTask = tasks.length > 0 ? tasks[tasks.length - 1] : null;fn.ctx = {thi$:thi$ || SANDBOX, callback:callback, args:sliceArgs.call(arguments, 3)};if (!curTask || curTask.state === 1) {tasks.push(task);running = false;} else {curTask.tasks = curTask.tasks || [];curTask.tasks.push(task);}if (!running) {running = true;_run.$delay(0);}};var _run = function () {var fn, ctx, promise, curTask = tasks.length > 0 ? tasks[tasks.length - 1] : null;if (!curTask) {running = false;return;}fn = curTask.fn;ctx = fn.ctx;switch (curTask.state) {case 0:curTask.state = 1;promise = {data:curTask.data, done:_done.$bind(this)};fn.apply(ctx.thi$, [promise].concat(ctx.args));break;case 2:if (Class.isFunction(ctx.callback)) {ctx.callback.apply(ctx.thi$, [curTask.data].concat(ctx.args));}fn.ctx = null;var task = curTask.tasks ? curTask.tasks.shift() : null;if (task) {task.data = curTask.data;task.tasks = curTask.tasks;tasks[tasks.length - 1] = task;} else {curTask = tasks.pop();task = tasks.length > 0 ? tasks[tasks.length - 1] : null;if (task) {task.state = 2;task.data = curTask.data;}}curTask.data = null;curTask.tasks = null;curTask.fn = null;_run.call(this);break;}};var _done = function (data) {var curTask = tasks[tasks.length - 1];curTask.state = 2;curTask.data = data;_run.call(this);};})();js.lang.Class = function () {var Class = this, classes = {"js.lang.Class":this};self.$package = function (name) {var clazz = classes[name], names;if (clazz) {return clazz;}clazz = self, names = name.split(".");(function (v) {var o = clazz[v];o = !o ? (clazz[v] = {}) : o;clazz = o;}).$forEach(names);classes[name] = clazz;return clazz;};self.$import = function (className) {var clazz = _checkClass(className);if (clazz) {return;}(function (promise) {_loadClass.call(this, className, promise.done);}).$queue(null, Class);};self.$define = function (fn) {if (!Class.isFunction(fn)) {return;}(function (promise) {fn.call(Class.SANDBOX);promise.done();}).$queue();};var _checkClass = function (className) {var clazz = classes[className], names;if (!clazz) {clazz = self, names = className.split(".");(function (v) {clazz = clazz[v];if (!clazz) {throw Class.BREAKLOOP;}}).$forEach(names);if (clazz) {classes[className] = clazz;}}return clazz;};this.forName = function (className) {var clazz = _checkClass(className);if (!clazz) {_loadClass.call(this, className);}return clazz;};var _loadClass = function (className, callback) {var clazz;console.log("load class: " + className);classes[className] = clazz;callback(clazz);};var _onreadscript = function (e) {var script, head, xhr = e.getData(), code = xhr.responseText();xhr.close();script = document.createElement("script");head = document.getElementsByTagName("head")[0];script.type = "text/javascript";script.text = code;head.appendChild(script);head.removeChild(script);};this.loadScript = function (filePath, text) {var b = !text;this.getResource(filePath, function (e) {var xhr = e.getData();text = xhr.responseText();}, b);text = text || this.getResource(filePath, !this.isString(text));var script = document.createElement("script");var head = document.getElementsByTagName("head")[0];script.type = "text/javascript";script.text = text;head.appendChild(script);head.removeChild(script);if (b) {this.packages.push(filePath);}return text;};this.getResource = function (url, callback, nocache) {var xhr = J$VM.XHRPool.getXHR(true);xhr.setNoCache(nocache || false);xhr.onsuccess = xhr.ontimeout = xhr.onhttperr = callback;xhr.open("GET", url);};return this;}.call(js.lang.Class);

js.lang.Math = function () {var Class = js.lang.Class, CRCT = [0, 1996959894, 3993919788, 2567524794, 124634137, 1886057615, 3915621685, 2657392035, 249268274, 2044508324, 3772115230, 2547177864, 162941995, 2125561021, 3887607047, 2428444049, 498536548, 1789927666, 4089016648, 2227061214, 450548861, 1843258603, 4107580753, 2211677639, 325883990, 1684777152, 4251122042, 2321926636, 335633487, 1661365465, 4195302755, 2366115317, 997073096, 1281953886, 3579855332, 2724688242, 1006888145, 1258607687, 3524101629, 2768942443, 901097722, 1119000684, 3686517206, 2898065728, 853044451, 1172266101, 3705015759, 2882616665, 651767980, 1373503546, 3369554304, 3218104598, 565507253, 1454621731, 3485111705, 3099436303, 671266974, 1594198024, 3322730930, 2970347812, 795835527, 1483230225, 3244367275, 3060149565, 1994146192, 31158534, 2563907772, 4023717930, 1907459465, 112637215, 2680153253, 3904427059, 2013776290, 251722036, 2517215374, 3775830040, 2137656763, 141376813, 2439277719, 3865271297, 1802195444, 476864866, 2238001368, 4066508878, 1812370925, 453092731, 2181625025, 4111451223, 1706088902, 314042704, 2344532202, 4240017532, 1658658271, 366619977, 2362670323, 4224994405, 1303535960, 984961486, 2747007092, 3569037538, 1256170817, 1037604311, 2765210733, 3554079995, 1131014506, 879679996, 2909243462, 3663771856, 1141124467, 855842277, 2852801631, 3708648649, 1342533948, 654459306, 3188396048, 3373015174, 1466479909, 544179635, 3110523913, 3462522015, 1591671054, 702138776, 2966460450, 3352799412, 1504918807, 783551873, 3082640443, 3233442989, 3988292384, 2596254646, 62317068, 1957810842, 3939845945, 2647816111, 81470997, 1943803523, 3814918930, 2489596804, 225274430, 2053790376, 3826175755, 2466906013, 167816743, 2097651377, 4027552580, 2265490386, 503444072, 1762050814, 4150417245, 2154129355, 426522225, 1852507879, 4275313526, 2312317920, 282753626, 1742555852, 4189708143, 2394877945, 397917763, 1622183637, 3604390888, 2714866558, 953729732, 1340076626, 3518719985, 2797360999, 1068828381, 1219638859, 3624741850, 2936675148, 906185462, 1090812512, 3747672003, 2825379669, 829329135, 1181335161, 3412177804, 3160834842, 628085408, 1382605366, 3423369109, 3138078467, 570562233, 1426400815, 3317316542, 2998733608, 733239954, 1555261956, 3268935591, 3050360625, 752459403, 1541320221, 2607071920, 3965973030, 1969922972, 40735498, 2617837225, 3943577151, 1913087877, 83908371, 2512341634, 3803740692, 2075208622, 213261112, 2463272603, 3855990285, 2094854071, 198958881, 2262029012, 4057260610, 1759359992, 534414190, 2176718541, 4139329115, 1873836001, 414664567, 2282248934, 4279200368, 1711684554, 285281116, 2405801727, 4167216745, 1634467795, 376229701, 2685067896, 3608007406, 1308918612, 956543938, 2808555105, 3495958263, 1231636301, 1047427035, 2932959818, 3654703836, 1088359270, 936918000, 2847714899, 3736837829, 1202900863, 817233897, 3183342108, 3401237130, 1404277552, 615818150, 3134207493, 3453421203, 1423857449, 601450431, 3009837614, 3294710456, 1567103746, 711928724, 3020668471, 3272380065, 1510334235, 755167117];this.crc32 = function (str) {var crc = 0, c, i, len, n;if (!Class.isString(str)) {return "0";}crc = crc ^ (-1);i = 0;len = str.length;while (i < len) {c = str.charCodeAt(i++);if (c <= 127) {crc = _crc(crc, c);} else {if (c >= 128 && c <= 32767) {crc = _crc(crc, ((c >> 6) & 31) | 192);crc = _crc(crc, (c & 63) | 128);} else {crc = _crc(crc, (c >> 12) | 224);crc = _crc(crc, ((c >> 6) & 63) | 128);crc = _crc(crc, (c & 63) | 128);}}}return ((crc ^ (-1)) >>> 0).toString(16);};var _crc = function (crc, c) {return (crc >>> 8) ^ CRCT[(crc ^ c) & 255];};return this;}.call(Math);

js.lang.String = function () {var REGX_HTML_ENCODE = /"|&|'|<|>|[\x00-\x20]|[\x7F-\xFF]|[\u0100-\u2700]/g;var REGX_HTML_DECODE = /&\w+;|&#(\d+);|<br\/>/g;var REGX_REGEXP_METACHARS = /[\^\$\.\*\+\?\|\\\(\)\[\]\{\}]/g;var REGX_REGEXP_ESCAPEDMETACHARS = /\\([\^\$\.\*\+\?\|\\\(\)\[\]\{\}])/g;var HTML_DECODE = {"&lt;":"<", "&gt;":">", "&amp;":"&", "&nbsp;":" ", "&quot;":"\"", "&copy;":"\xa9"};var Class = js.lang.Class;this.encodeHtml = function encodeHtml(s, nobreak, ignoreSpace) {s = s || this.toString();var o;return (typeof s != "string") ? s : s.replace(REGX_HTML_ENCODE, function ($0) {var c = $0.charCodeAt(0), r = ["&#"];if (c == 13 && nobreak != true) {o = c;return "<br/>";}if (c == 10 && nobreak != true) {return (o == 13) ? "" : "<br/>";}if (c == 32 || c == 160) {if (ignoreSpace !== true) {c = (c == 32) ? 160 : c;} else {c = (c == 160) ? 32 : c;return String.fromCharCode(c);}}r.push(c);r.push(";");return r.join("");});};this.decodeHtml = function decodeHtml(s, nobreak) {s = (s != undefined) ? s : this.toString();return (typeof s != "string") ? s : s.replace(REGX_HTML_DECODE, function ($0, $1) {var c = HTML_DECODE[$0];if (c == undefined) {if (!isNaN($1)) {c = String.fromCharCode(($1 == 160) ? 32 : $1);} else {c = $0;}}return c;});};this.escapeRegExp = function escapeRegExp() {var str = this.toString();return str.replace(REGX_REGEXP_METACHARS, function ($0) {return "\\" + $0;});};this.unescapeRegExp = function unescapeRegExp() {var str = this.toString();return str.replace(REGX_REGEXP_ESCAPEDMETACHARS, function ($0, ch) {return ch;});};this.hashCode = this.hashCode || function hashCode() {var hash = this.__hash__, c, i, len;if (hash) {return hash;}hash = 0;for (i = 0, len = this.length; i < len; i++) {c = this.charCodeAt(i);hash = 31 * hash + c;hash = hash & hash;}hash = hash & 2147483647;return (this.__hash__ = hash);};return String;}.call(String.prototype);

$package("js.lang");js.lang.Object = function () {var CLASS = js.lang.Object, thi$ = CLASS.prototype;if (CLASS.__defined__) {return;}CLASS.__defined__ = "js.lang.Object";thi$.uuid = function () {return Math.uuid(this);};thi$.hashCode = function () {return Math.hash(this);};thi$.toString = function () {return ["Object@", this.uuid()].join("");};}.$extend(Object);$package("js.util");js.util.EventTarget = function (def) {var CLASS = js.util.EventTarget, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.util.EventTarget";var Class = js.lang.Class, Event = js.util.Event, J$VMMSG = Event.J$VM_MSG, oTable = {}, eTable = {}, Q = [], running;thi$.attachEvent = function (type, fn, listener, args) {var uuid = this.uuid(), map = eTable[type] = (eTable[type] || {}), handlers = map[uuid] = (map[uuid] || []);args = Class.sliceArgs(arguments, 3);handlers.push([fn, listener, args]);};thi$.detachEvent = function (type, fn) {var uuid = this.uuid(), map = eTable[type], handlers = map ? map[uuid] : null;(function (h, i) {if (h[0] === fn) {handlers.splice(i, 1);throw Class.BREAKLOOP;}}).$forEach(handlers);if (!handlers || handlers.length === 0) {delete map[uuid];}};thi$.disableEvents = function (types) {var map = this.__local__.disabledEvents, i, len;types = types || [];for (i = 0, len = types.length; i < len; i++) {map[types[i]] = 1;}};thi$.enableEvents = function (types) {var map = this.__local__.disabledEvents, i, len;types = types || [];for (i = 0, len = types.length; i < len; i++) {map[types[i]] = null;}};thi$.fireEvent = function (e) {var uuid = this.uuid(), type = e.getType(), target, t = _checkType.call(this, type), map = eTable[t], handlers = map ? map[uuid] : null, fn, i, len;if (Class.isFunction(fn = this[["on", null].join(t)])) {try {fn.call(this, e);}catch (x) {J$VM.System.err.println(x);}}(function (h) {fn = h[0];try {fn.apply((h[1] || this), [e].concat(h[2]));}catch (x) {J$VM.System.err.println(x);}}).$forEach(handlers);e._last = new Date();if (e._bubble && (target = _findTarget.call(this, type))) {target.fireEvent(e);}};var _checkType = function (type) {return this.__local__.disabledEvents[type] ? null : type;};var _findTarget = function (type) {var parent = this.getParent(), map, handlers;while (parent) {map = eTable[_checkType.call(parent, type)];handlers = map ? map[parent.uuid()] : null;if (handlers && handlers.length > 0) {break;} else {parent = parent.getParent();}}return parent;};var getTarget = function (uuid) {var ctx = oTable[uuid];return ctx ? ctx["."] : null;};thi$.dispatchEvent = function (e) {e.cancelBubble();this.postMessage(e.getType(), e);};thi$.postMessage = function (type, data, recvs, device) {recvs = (Class.isArray(recvs) && recvs.length > 0) ? recvs : null;Q.push([type, data, recvs, device]);if (!running) {running = true;schedule.$delay(0);}};thi$.sendMessage = function (type, data, recvs, device) {dispatch([type, data, recvs, device]);};var schedule = function () {dispatch(Q.shift());if ((running = (Q.length > 0))) {schedule.$delay(0);}};var dispatch = function (pack) {var type, data, recv, devi, msg, map, target, fn;type = pack[0];data = pack[1];devi = pack[3];if (devi) {if (Class.isString(devi)) {devi = self.document.getElementById(devi);devi = devi ? devi.contentWindow : self.parent;}msg = JSON.stringify([J$VMMSG, {type:type, data:data}]);if (J$VM.isworker) {devi.postMessage(msg);} else {devi.postMessage(msg, "*");}} else {map = eTable[type];recv = pack[2] || Class.keysOf(map);(function (uuid) {target = getTarget(uuid);if (!target) {delete map[uuid];return;}if (data instanceof Event) {target.fireEvent(data);} else {(function (h) {fn = h[0];target = h[1] || target;fn.apply(target, [data].concat(h[2]));}).$forEach(map[uuid]);}}).$forEach(recv);}};thi$.setParent = function (parent) {if (parent instanceof CLASS) {this.__local__.parent = parent;if (!this.linkContext()) {this.linkContext(parent.uuid());}}};thi$.getParent = function () {return this.__local__.parent;};thi$.linkContext = function (uuid) {var ctx = this.getContext();return oTable[((uuid) ? (ctx[".."] = uuid) : ctx[".."])];};thi$.getContext = function () {return oTable[this.__uuid__];};thi$.getContextAttr = function (name) {var ctx = this.getContext();if (ctx.hasOwnProperty(name)) {return ctx[name];} else {ctx = this.getEventTarget(ctx[".."]);return ctx ? ctx.getContextAttr(name) : null;}};thi$.putContextAttr = function (name, value) {var ctx = this.getContext();if (name) {ctx[name] = value;}};thi$.getEventTarget = function (uuid) {return getTarget(uuid);};thi$.getRuntime = function () {this.getContextAttr("__runtime__");};thi$.destroy = function () {var uuid = this.__uuid__, ctx = oTable[uuid];ctx["."] = null;oTable[uuid] = null;this.__locale__ = null;};thi$._init = function (def) {if (arguments.length === 0) {return;}var uuid = this.__uuid__ = (def.uuid || this.uuid()), ctx = oTable[uuid] = {".":this, "..":def.context};this.__local__ = {disabledEvents:{}};};this._init.apply(this, arguments);}.$extend(js.lang.Object);js.util.Event = function (type, data, source, canBubble) {var CLASS = js.util.Event, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.util.Event";var Class = js.lang.Class;thi$.getType = function () {return this._type;};thi$.setType = function (type) {this._type = type;};thi$.getData = function () {return this._data;};thi$.setData = function (data) {this._data = data;};thi$.getEventSource = function () {return this._source;};thi$.setEventSource = function (src) {if (!(src instanceof js.util.EventTarget)) {throw "The target must be an instance of EventTarget";}this._source = src;};thi$.cancelBubble = function () {var e = this._event;if (e) {if (e.stopPropagation) {e.stopPropagation();} else {try {e.cancelBubble = true;}catch (x) {}}}return (this._bubble = false);};thi$.cancelDefault = function () {var e = this._event;if (e) {if (e.preventDefault) {e.preventDefault();} else {try {e.returnValue = false;}catch (x) {}}}return (this._default = false);};thi$.getTimeStamp = function () {return this._time;};var BTNS = [1, 4, 2, 8, 16], DomE = !J$VM.isworker ? self.document.documentElement : null, Body = !J$VM.isworker ? self.document.body : null;var _initRealEvent = function (e) {this._type = e.type;this._data = this._event = e;if (e.altKey !== undefined) {this.altKey = e.altKey;this.ctrlKey = e.ctrlKey;this.shiftKey = e.shiftKey;this.metaKey = e.metaKey;this.keyCode = e.which || e.keyCode;}if (e.pageX !== undefined || e.clientX !== undefined) {this.button = e.buttons ? e.buttons : (!J$VM.ie && e.button >= 0) ? BTNS[e.button] : e.button;this.pointerId = e.pointerId || 0;this.absX = !isNaN(e.pageX) ? e.pageX : (e.clientX + DomE.scrollLeft - Body.clientLeft);this.absY = !isNaN(e.pageY) ? e.pageY : (e.clientY + DomE.scrollTop - Body.clientTop);this.eventXY = function () {return {x:this.absX, y:this.absY};};}this.srcElement = e.srcElement || e.target;};var _initJsvmEvent = function (type, data, source, canBubble) {this._type = type;this._data = data;this._source = source;this._bubble = (canBubble === undefined) || canBubble;};thi$._init = function (type, data, source, canBubble) {if (arguments.length === 0) {return;}if (!Class.isString(type)) {_initRealEvent.call(this, type || self.event);} else {_initJsvmEvent.apply(this, arguments);}this._default = true;this._time = new Date();};this._init.apply(this, arguments);}.$extend(js.lang.Object);(function () {var CLASS = this, Class = js.lang.Class, agents = {};var hash = function (obj) {return obj ? Math.hash(obj) : 0;};var uuid = function (e, t, f, o) {return [t, hash(e), hash(f), hash(o)].join("");};this.attachEvent = function (ele, type, fn, listener, args) {var id = uuid(ele, type, fn, listener), agent;if (agents[id]) {return;}args = Class.sliceArgs(arguments, 4);agent = agents[id] = function () {return function (e) {fn.apply(listener, [new CLASS(e)].concat(args));};}();if (ele.addEventListener) {ele.addEventListener(type, agent, false);} else {ele.attachEvent(["on", type].join(""), agent);}};this.detachEvent = function (ele, type, fn, listener) {var id = uuid(ele, type, fn, listener), agent;if (!(agent = agents[id])) {return;}if (ele.removeEventListener) {ele.removeEventListener(type, agent, false);} else {ele.detachEvent(["on", type].join(""), agent);}delete agents[id];};this.J$VM_MSG = "-j$vm-message";this.J$VM_HANDSHAKE = "-j$vm-handshake";this.J$VM_RESIZE = "-j$vm-resize";}).call(js.util.Event);

$package("js.util");js.util.Event = function (type, data, source, target) {var CLASS = js.util.Event, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}var Class = js.lang.Class;thi$.cancelBubble = function () {this.bubbleable = false;};thi$.cancelDefault = function () {this.defaultprc = false;};thi$._init = function (type, data, source, target) {if (arguments.length === 0) {return;}this.type = type;this.data = data;this.source = source;this.target = target;this.bubbleable = true;this.defaultprc = true;this.timestamp = new Date();};this._init.apply(this, arguments);};(function () {var Class = js.lang.Class, Event = this, sliceArgs = Array.prototype.slice;this.FLAG = {EXCLUSIVE:1 << 0, CAPTURED:1 << 1, CUSTOMIZED:1 << 2, check:function (f) {var o = {exclusive:false, captured:false, customized:false};if (Class.isNumber(f)) {o.exclusive = (f & this.EXCLUSIVE) != 0;o.captured = (f & this.CAPTURED) != 0;o.customized = (f & this.CUSTOMIZED) != 0;} else {o.exclusive = (f === true);}return o;}};this.attachEvent = function (target, eType, flag, thi$, handler) {var fn, args, hs, check = this.FLAG.check(flag);args = sliceArgs.call(arguments, 5);fn = function (e) {if (!(e instanceof Event)) {e = new Event(e.type, e);}args.unshift(e);handler.apply(thi$, args);};fn.__thi$__ = thi$;fn.__hostf__ = handler;fn.__check__ = check;hs = target.__handlers__ = target.__handlers__ || {};hs = hs[eType] = hs[eType] || [];hs.push(fn);if (check.exclusive) {target["on" + eType] = fn;} else {if (target.addEventListener) {target.addEventListener(eType, fn, check.captured);} else {target.attachEvent("on" + eType, fn);}}return fn;};this.detachEvent = function (target, eType, flag, thi$, handler) {var fn, hs, check;hs = target.__handlers__ = target.__handlers__ || {};hs = hs[eType] = hs[eType] || [];for (var i = 0; i < hs.length; i++) {fn = hs[i];if (handler && (fn.__thi$__ !== thi$ || fn.__hostf__ !== handler)) {continue;}check = fn.__check__;if (check.exclusive) {target["on" + eType] = null;} else {if (target.removeEventListener) {target.removeListener(eType, fn, check.captured);} else {target.detachEvent("on" + eType, fn);}}fn.__thi$__ = null;fn.__hostf__ = null;fn.__check__ = null;hs.splice(i, 1);}};this.W3C_EVT_LOAD = "load";this.W3C_EVT_UNLOAD = "unload";this.W3C_EVT_RESIZE = "resize";}).call(js.util.Event);

$package("js.util");js.util.EventTarget = function (def) {var CLASS = js.util.EventTarget, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}var Class = js.lang.Class, System = J$VM.System, Event = js.util.Event, sliceArgs = Array.prototype.slice;thi$.attachEvent = function (eType, flag, thi$, fn, args) {var name = ["on", eType].join(""), handler;fn.ctx = {uuid:this.uuid(), thi$:thi$, func:fn, args:sliceArgs.call(arguments, 4)}, handler = this[name] = (this[name] || []);handler.push(fn.ctx);switch (flag) {case 0:case 1:Event.attachEvent(this, eType, flag, thi$, fn, args);break;case 2:var desk = this.getObject("desktop");Event.attachEvent(desk, eType, flag, thi$, fn, args);break;case 4:System.attachEvent(eType, flag, thi$, fn, args);break;}};thi$.detachEvent = function (eType, flag, thi$, fn) {};thi$.dispatchEvent = function (e, channel, recvs) {System.dispatchEvent(e, channel, recvs);};thi$.fireEvent = function (e, bubble) {var handler = this["on" + e.type];switch (Class.typeOf(handler)) {case "Function":handler.call(this, e);break;case "Array":_call.$forEach(handler, this, e);break;}if (bubble && e.bubbleable) {var parent = this.getParent();if (parent && parent.fireEvent) {parent.fireEvent.call(parent, e, bubble);}}};var _call = function (ctx, i, arrays, e) {ctx.fn.apply(ctx.thi$, [e].concat(ctx.args));};thi$.canCapture = function () {if (Class.isHtmlElement(this.view)) {return true;}var b = this.def ? this.def.capture : false;if (b) {var parent = this.getParent();b &= ((parent && parent.canCapture) ? parent.canCapture() : false);}return b;};thi$.destroy = function () {$super(this);};thi$._init = function (def) {if (arguments.length === 0) {return;}$super(this);};this._init.apply(this, arguments);}.$extend(js.lang.Object);

$package("js.lang");js.lang.System = J$VM = function (env) {var CLASS = js.lang.System, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.lang.System";var Class = js.lang.Class, System = this, Event = js.util.Event, URI = js.net.URI, isworker, os, props;thi$.out = {println:function (s) {os.info(s);}};thi$.err = {println:function (s) {os.error(s);}};thi$.log = {println:function (s) {if (this.logEnabled()) {os.log(s);}}};thi$.logEnabled = function () {return this.getProperty("j$vm_log") === true;};thi$.enableLogger = function (b) {b = (b === undefined) || b;this.setProperty("j$vm_log", b);J$VM.sessnStorage.setItem("j$vm_log", b);return ["J$VM logger enabled is ", b].join("");};thi$.hasProperty = function (key) {return Class.hasKey(props, key);};thi$.getProperty = function (key, defValue) {return this.hasProperty(key) ? props[key] || defValue : defValue;};thi$.setProperty = function (key, value) {var pre = null;if (key) {pre = props[key];props[key] = value;}return pre;};thi$.objectCopy = function (src, des, deep, unmerge) {switch (Class.typeOf(src)) {case "Object":des = des || {};Math.forObject(src, function (v, k) {des[k] = (!deep || !Class.isObject(v)) ? v : this.objectCopy(v, (unmerge ? null : des[k]), deep, unmerge);}, this);break;case "Array":des = this.arrayCopy(src, 0, des, 0, src.length, deep);break;default:des = src;}return des;};thi$.arrayCopy = function (src, srcIdx, des, desIdx, length, deep) {var len = src.length - srcIdx;length = Class.isNumber(length) ? ((length > len) ? len : length) : len;des = des || [];Math.forArray(src, function (v, i) {if (i < srcIdx) {return;}if (i > srcIdx + length - 1) {throw Class.BREAKLOOP;}des[desIdx + i - srcIdx] = (!deep || !Class.isObject(v)) ? v : this.objectCopy(v, null, deep);}, this);return des;};var _onload = function (e) {System.out.println([J$VM.__product__, J$VM.__version__, "loading..."].join(" "));var U = this.__local__;saveUSize(U);if (self !== self.parent) {System.out.println("Handshake with outer J$VM.");this.postMessage(Event.J$VM_HANDSHAKE, null, null, self.parent);}};var _unload = function (e) {Event.detachEvent(self, "message", _onmessage, this);if (!isworker) {Event.attachEvent(self, "load", _onload, this);Event.attachEvent(self, "unload", _unload, this);Event.attachEvent(self, "resize", _resize, this);self.document.innerHTML = "";}System.out.println([J$VM.__product__, "unload."].join(" "));};var _resize = function (e) {var U = this.__local__;if (self.innerWidth != U.userW || self.innerHeight || U.userH) {saveUSize(U);e.setType(Event.J$VM_RESIZE);e.setData({width:U.userW, height:U.userH});this.dispatchEvent(e);}};var saveUSize = function (U) {U.userW = self.innerWidth;U.userH = self.innerHeight;};var _onmessage = function (e) {var _e = e._event, msg;if (self === _e.source) {return;}try {msg = JSON.parse(_e.data);}catch (x) {return;}if (Class.isArray(msg) && msg[0] === Event.J$VM_MSG) {msg = msg[1];e.setType(msg.type);e.setData(msg.data);this.dispatchEvent(e);}};var _onhandshake = function (e) {var source = e._event.source, ele;if (source !== self.parent) {ele = source.frameElement;ele.id = Math.uuid(ele);ele.setAttribute("jsvm_embedded", "true");System.out.println("Handshake with inner J$VM " + ele.id);this.postMessage(Event.J$VM_HANDSHAKE, null, null, ele.id);} else {this.isEmbedded = true;System.out.println("This J$VM is embedded.");}};var _initWorker = function () {os = new function () {var type = Event.J$VM_MSG, post = self.postMessage, msg = function (t, s) {return JSON.stringify([type, {type:t, data:s}]);};this.info = function (s) {post(msg("-j$vm-inf", s));};this.error = function (s) {post(msg("-j$vm-err", s));};this.log = function (s) {post(msg("-j$vm-log", s));};}();var A = self.location, uri, crs;uri = props.j$vm_uri = new URI(A.protocol, A.username, A.password, A.hostname, A.port, A.pathname, A.search, A.hash, A.href);crs = props.j$vm_crs = "../../../";props.j$vm_home = [uri.uriPath(), crs].join("");props.j$vm_classpath = [""];};var _initBrowser = function () {os = self.console || {info:function (s) {}, error:function (s) {}, log:function (s) {}};var stag = document.getElementById("j$vm"), uri, crs, cp;if (stag) {uri = props.j$vm_uri = URI.parse(stag.src || stag.getAttribute("crs"));crs = props.j$vm_crs = stag.getAttribute("crs");props.j$vm_home = crs.startsWith("http") ? crs : URI.makeURIString(uri.uriPath(), crs);cp = stag.getAttribute("classpath");props.j$vm_classpath = cp ? cp.split(";") : [""];}var storage = js.util.Storage;J$VM.localStorage = storage.local();J$VM.sessnStorage = storage.session();J$VM.classesCache = storage.classCache();System.enableLogger(J$VM.sessnStorage.getItem("j$vm_log") || false);J$VM.enableLogger = function () {return System.enableLogger(true);};J$VM.disableLogger = function () {return System.enableLogger(false);};Event.attachEvent(self, "load", _onload, this);Event.attachEvent(self, "unload", _unload, this);Event.attachEvent(self, "resize", _resize, this);Event.attachEvent(self, "message", _onmessage, this);this.attachEvent(Event.J$VM_HANDSHAKE, _onhandshake);};thi$._init = function (env) {if (J$VM.System) {return;}$super(this, {uuid:"__system__"});self.__uuid__ = this.uuid();props = env || {};if ((J$VM.isworker = !(self.document))) {_initWorker.call(this);} else {_initBrowser.call(this);}}.$override(this._init);this._init.apply(this, arguments);}.$extend(js.util.EventTarget);(function () {this.__product__ = "J$VM";this.__version__ = "1.0.";this.env = {};this.System = new js.lang.System(this.env);}).call(J$VM);

