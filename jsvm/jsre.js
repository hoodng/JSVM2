self.js = self.js || {};(function () {var TYPES = ["Null", "Undefined", "Function", "Object", "Array", "Boolean", "Number", "String", "Date"], lang = js.lang = {Class:function () {}}, Class = lang.Class, Func = Function.prototype, SANDBOX = Class.SANDBOX = {name:"j$vm-sandbox"}, BREAKLOOP = Class.BREAKLOOP = "break-loop", sliceArgs = Array.prototype.slice, typeString = Object.prototype.toString, hasKey = Object.prototype.hasOwnProperty;(function () {var REGX_TRIM = /(^\s*)|(\s*$)/g;this.trim = this.trim || function () {return this.toString().replace(REGX_TRIM, "");};this.startsWith = this.startsWith || function (s) {return this.indexOf(s) === 0;};this.endsWith = this.endsWith || function (s) {return this.indexOf(s, this.length - s.length) !== -1;};}).call(String.prototype);Class.typeOf = function (x, type) {var s = typeString.call(x);s = s.substring(8, s.length - 1);return arguments.length > 1 ? s === type : s;};Class.sliceArgs = function (args, n) {return sliceArgs.call(args, n || 0);};Class.hasKey = function (obj, key) {return hasKey.call(obj, key);};Class.keysOf = function (obj) {var keys = [];(function (v, k) {keys.push(k);}).$forEach(obj);return keys;};Class.entrySet = function (obj) {var keys = [];(function (v, k) {keys.push({key:k, value:v});}).$forEach(obj);return keys;};Math.forArray = function (set, fn, thi$, args) {thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);for (var i = 0, len = set.length; i < len; i++) {try {fn.apply(thi$, [set[i], i, set].concat(args));}catch (x) {if (x === BREAKLOOP) {break;}throw x;}}};Math.forObject = function (set, fn, thi$, args) {thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);for (var i in set) {if (!hasKey.call(set, i)) {continue;}try {fn.apply(thi$, [set[i], i, set].concat(args));}catch (x) {if (x === BREAKLOOP) {break;}throw x;}}};Func.$forEach = function (set, thi$, args) {if (!set) {return;}Math[["for", null].join(Class.typeOf(set))].apply(SANDBOX, [set, this].concat(sliceArgs.call(arguments, 1)));};(function (type) {Class[["is", null].join(type)] = function (x) {return this.typeOf(x, type);};}).$forEach(TYPES);var last = (new Date()).getTime(), DIFF = (1 << 16) + (1 << 8) + 1;Math.hash = function (obj) {var now = obj ? obj.__hash__ : null;if (!now) {now = (new Date()).getTime();if (now <= last) {now = last + DIFF;}if (obj) {obj.__hash__ = now;}last = now;}return now;};Math.uuid = function (obj) {var id = obj ? obj.__uuid__ : null;if (!id) {id = [null, this.hash(obj).toString(16)].join("s");if (obj) {obj.__uuid__ = id;}}return id;};Func.$bind = function (thi$, args) {var fn = this;args = sliceArgs.call(arguments, 1);return function () {return fn.apply(thi$, sliceArgs.call(arguments).concat(args));};};Func.$override = function (fn) {this.__super__ = fn;return this;};self.$super = function (thi$, args) {var caller = self.$super.caller;args = arguments.length > 1 ? sliceArgs.call(arguments, 1) : sliceArgs.call(caller.arguments);return caller.__super__.apply(thi$, args);};var tTable = {};Func.$delay = function (timeout, thi$, args) {var fn = this, uuid = Math.uuid(fn), timer, ts = tTable[uuid] = (tTable[uuid] || []);thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 2);timer = self.setTimeout(function () {fn.$cancel(timer);fn.apply(thi$, args);}, timeout);ts.push(timer);return timer;};Func.$cancel = function (timer) {var fn = this, uuid = Math.uuid(fn), ts = tTable[uuid] = (tTable[uuid] || []);timer = arguments.length == 0 ? ts.shift() : timer;(function (t, i) {if (t === timer) {ts.splice(i, 1);throw BREAKLOOP;}}).$forEach(ts);if (ts.length === 0) {delete tTable[uuid];}};Func.$loop = function (testP, thi$, args) {var fn = this;thi$ = thi$ || SANDBOX;args = sliceArgs.call(arguments, 3);if (testP.apply(thi$, args)) {fn.apply(thi$, args);(function () {fn.$loop.apply(fn, [testP, thi$].concat(args));}).$delay(0);}};Func.$queue = function (callback, thi$, args) {_queue.apply(SANDBOX, [this].concat(sliceArgs.call(arguments)));};Func.$extend = function (clazz) {var proto;if (Class.isFunction(clazz)) {proto = new (clazz)();proto.constructor = clazz;} else {if (clazz) {proto = clazz;}}this.prototype = proto;return this;};Func.$decorate = function (obj, replace) {var clazz = this;if (!obj) {return null;}if (!clazz.__defined__) {new (clazz)();}replace = replace || {};(function (e, k) {if (Class.isFunction(e) && (!obj[k] || replace[k])) {obj[k] = e;}}).forEach(clazz.prototype);return obj;};Func.$implements = function (clazz) {var proto = this.prototype, impls;impls = proto.__impls__ = [].concat(proto.__impls__ || []);(function (fn) {if (Class.isFunction(fn)) {impls.push(fn);fn.$decorate(proto);}}).$forEach(sliceArgs.call(arguments));return this;};var tasks = [], running;var _queue = function (fn, callback, thi$, args) {var task = {state:0, fn:fn, data:null}, curTask = tasks.length > 0 ? tasks[tasks.length - 1] : null;fn.ctx = {thi$:thi$ || SANDBOX, callback:callback, args:sliceArgs.call(arguments, 3)};if (!curTask || curTask.state === 1) {tasks.push(task);running = false;} else {curTask.tasks = curTask.tasks || [];curTask.tasks.push(task);}if (!running) {running = true;_run.$delay(0);}};var _run = function () {var fn, ctx, promise, curTask = tasks.length > 0 ? tasks[tasks.length - 1] : null;if (!curTask) {running = false;return;}fn = curTask.fn;ctx = fn.ctx;switch (curTask.state) {case 0:curTask.state = 1;promise = {data:curTask.data, done:_done.$bind(this)};fn.apply(ctx.thi$, [promise].concat(ctx.args));break;case 2:if (Class.isFunction(ctx.callback)) {ctx.callback.apply(ctx.thi$, [curTask.data].concat(ctx.args));}fn.ctx = null;var task = curTask.tasks ? curTask.tasks.shift() : null;if (task) {task.data = curTask.data;task.tasks = curTask.tasks;tasks[tasks.length - 1] = task;} else {curTask = tasks.pop();task = tasks.length > 0 ? tasks[tasks.length - 1] : null;if (task) {task.state = 2;task.data = curTask.data;}}curTask.data = null;curTask.tasks = null;curTask.fn = null;_run.call(this);break;}};var _done = function (data) {var curTask = tasks[tasks.length - 1];curTask.state = 2;curTask.data = data;_run.call(this);};})();js.lang.Class = function () {var Class = this, classes = {"js.lang.Class":this};self.$package = function (name) {var clazz = classes[name], names;if (clazz) {return clazz;}clazz = self, names = name.split(".");(function (v) {var o = clazz[v];o = !o ? (clazz[v] = {}) : o;clazz = o;}).$forEach(names);classes[name] = clazz;return clazz;};self.$import = function (className) {var clazz = _checkClass(className);if (clazz) {return;}(function (promise) {_loadClass.call(this, className, promise.done);}).$queue(null, Class);};self.$define = function (fn) {if (!Class.isFunction(fn)) {return;}(function (promise) {fn.call(Class.SANDBOX);promise.done();}).$queue();};var _checkClass = function (className) {var clazz = classes[className], names;if (!clazz) {clazz = self, names = className.split(".");(function (v) {clazz = clazz[v];if (!clazz) {throw Class.BREAKLOOP;}}).$forEach(names);if (clazz) {classes[className] = clazz;}}return clazz;};this.forName = function (className) {var clazz = _checkClass(className);if (!clazz) {_loadClass.call(this, className);}return clazz;};var _loadClass = function (className, callback) {var clazz;console.log("load class: " + className);classes[className] = clazz;callback(clazz);};var _onreadscript = function (e) {var script, head, xhr = e.getData(), code = xhr.responseText();xhr.close();script = document.createElement("script");head = document.getElementsByTagName("head")[0];script.type = "text/javascript";script.text = code;head.appendChild(script);head.removeChild(script);};this.loadScript = function (filePath, text) {var b = !text;this.getResource(filePath, function (e) {var xhr = e.getData();text = xhr.responseText();}, b);text = text || this.getResource(filePath, !this.isString(text));var script = document.createElement("script");var head = document.getElementsByTagName("head")[0];script.type = "text/javascript";script.text = text;head.appendChild(script);head.removeChild(script);if (b) {this.packages.push(filePath);}return text;};this.getResource = function (url, callback, nocache) {var xhr = J$VM.XHRPool.getXHR(true);xhr.setNoCache(nocache || false);xhr.onsuccess = xhr.ontimeout = xhr.onhttperr = callback;xhr.open("GET", url);};return this;}.call(js.lang.Class);

$package("js.lang");js.lang.Object = function () {var CLASS = js.lang.Object, thi$ = CLASS.prototype;if (CLASS.__defined__) {return;}CLASS.__defined__ = "js.lang.Object";thi$.uuid = function () {return Math.uuid(this);};thi$.hashCode = function () {return Math.hash(this);};thi$.toString = function () {return ["Object@", this.uuid()].join("");};}.$extend(Object);$package("js.util");js.util.EventTarget = function (def) {var CLASS = js.util.EventTarget, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.util.EventTarget";var Class = js.lang.Class, Event = js.util.Event, J$VMMSG = Event.J$VM_MSG, oTable = {}, eTable = {}, Q = [], running;thi$.attachEvent = function (type, fn, listener, args) {var uuid = this.uuid(), map = eTable[type] = (eTable[type] || {}), handlers = map[uuid] = (map[uuid] || []);args = Class.sliceArgs(arguments, 3);handlers.push([fn, listener, args]);};thi$.detachEvent = function (type, fn) {var uuid = this.uuid(), map = eTable[type], handlers = map ? map[uuid] : null;(function (h, i) {if (h[0] === fn) {handlers.splice(i, 1);throw Class.BREAKLOOP;}}).$forEach(handlers);if (!handlers || handlers.length === 0) {delete map[uuid];}};thi$.disableEvents = function (types) {var map = this.__local__.disabledEvents, i, len;types = types || [];for (i = 0, len = types.length; i < len; i++) {map[types[i]] = 1;}};thi$.enableEvents = function (types) {var map = this.__local__.disabledEvents, i, len;types = types || [];for (i = 0, len = types.length; i < len; i++) {map[types[i]] = null;}};thi$.fireEvent = function (e) {var uuid = this.uuid(), type = e.getType(), target, t = _checkType.call(this, type), map = eTable[t], handlers = map ? map[uuid] : null, fn, i, len;if (Class.isFunction(fn = this[["on", null].join(t)])) {try {fn.call(this, e);}catch (x) {J$VM.System.err.println(x);}}(function (h) {fn = h[0];try {fn.apply((h[1] || this), [e].concat(h[2]));}catch (x) {J$VM.System.err.println(x);}}).$forEach(handlers);e._last = new Date();if (e._bubble && (target = _findTarget.call(this, type))) {target.fireEvent(e);}};var _checkType = function (type) {return this.__local__.disabledEvents[type] ? null : type;};var _findTarget = function (type) {var parent = this.getParent(), map, handlers;while (parent) {map = eTable[_checkType.call(parent, type)];handlers = map ? map[parent.uuid()] : null;if (handlers && handlers.length > 0) {break;} else {parent = parent.getParent();}}return parent;};var getTarget = function (uuid) {var ctx = oTable[uuid];return ctx ? ctx["."] : null;};thi$.dispatchEvent = function (e) {e.cancelBubble();this.postMessage(e.getType(), e);};thi$.postMessage = function (type, data, recvs, device) {recvs = (Class.isArray(recvs) && recvs.length > 0) ? recvs : null;Q.push([type, data, recvs, device]);if (!running) {running = true;schedule.$delay(0);}};thi$.sendMessage = function (type, data, recvs, device) {dispatch([type, data, recvs, device]);};var schedule = function () {dispatch(Q.shift());if ((running = (Q.length > 0))) {schedule.$delay(0);}};var dispatch = function (pack) {var type, data, recv, devi, msg, map, target, fn;type = pack[0];data = pack[1];devi = pack[3];if (devi) {if (Class.isString(devi)) {devi = self.document.getElementById(devi);devi = devi ? devi.contentWindow : self.parent;}msg = JSON.stringify([J$VMMSG, {type:type, data:data}]);if (J$VM.isworker) {devi.postMessage(msg);} else {devi.postMessage(msg, "*");}} else {map = eTable[type];recv = pack[2] || Class.keysOf(map);(function (uuid) {target = getTarget(uuid);if (!target) {delete map[uuid];return;}if (data instanceof Event) {target.fireEvent(data);} else {(function (h) {fn = h[0];target = h[1] || target;fn.apply(target, [data].concat(h[2]));}).$forEach(map[uuid]);}}).$forEach(recv);}};thi$.setParent = function (parent) {if (parent instanceof CLASS) {this.__local__.parent = parent;if (!this.linkContext()) {this.linkContext(parent.uuid());}}};thi$.getParent = function () {return this.__local__.parent;};thi$.linkContext = function (uuid) {var ctx = this.getContext();return oTable[((uuid) ? (ctx[".."] = uuid) : ctx[".."])];};thi$.getContext = function () {return oTable[this.__uuid__];};thi$.getContextAttr = function (name) {var ctx = this.getContext();if (ctx.hasOwnProperty(name)) {return ctx[name];} else {ctx = this.getEventTarget(ctx[".."]);return ctx ? ctx.getContextAttr(name) : null;}};thi$.putContextAttr = function (name, value) {var ctx = this.getContext();if (name) {ctx[name] = value;}};thi$.getEventTarget = function (uuid) {return getTarget(uuid);};thi$.getRuntime = function () {this.getContextAttr("__runtime__");};thi$.destroy = function () {var uuid = this.__uuid__, ctx = oTable[uuid];ctx["."] = null;oTable[uuid] = null;this.__locale__ = null;};thi$._init = function (def) {if (arguments.length === 0) {return;}var uuid = this.__uuid__ = (def.uuid || this.uuid()), ctx = oTable[uuid] = {".":this, "..":def.context};this.__local__ = {disabledEvents:{}};};this._init.apply(this, arguments);}.$extend(js.lang.Object);js.util.Event = function (type, data, source, canBubble) {var CLASS = js.util.Event, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.util.Event";var Class = js.lang.Class;thi$.getType = function () {return this._type;};thi$.setType = function (type) {this._type = type;};thi$.getData = function () {return this._data;};thi$.setData = function (data) {this._data = data;};thi$.getEventSource = function () {return this._source;};thi$.setEventSource = function (src) {if (!(src instanceof js.util.EventTarget)) {throw "The target must be an instance of EventTarget";}this._source = src;};thi$.cancelBubble = function () {var e = this._event;if (e) {if (e.stopPropagation) {e.stopPropagation();} else {try {e.cancelBubble = true;}catch (x) {}}}return (this._bubble = false);};thi$.cancelDefault = function () {var e = this._event;if (e) {if (e.preventDefault) {e.preventDefault();} else {try {e.returnValue = false;}catch (x) {}}}return (this._default = false);};thi$.getTimeStamp = function () {return this._time;};var BTNS = [1, 4, 2, 8, 16], DomE = !J$VM.isworker ? self.document.documentElement : null, Body = !J$VM.isworker ? self.document.body : null;var _initRealEvent = function (e) {this._type = e.type;this._data = this._event = e;if (e.altKey !== undefined) {this.altKey = e.altKey;this.ctrlKey = e.ctrlKey;this.shiftKey = e.shiftKey;this.metaKey = e.metaKey;this.keyCode = e.which || e.keyCode;}if (e.pageX !== undefined || e.clientX !== undefined) {this.button = e.buttons ? e.buttons : (!J$VM.ie && e.button >= 0) ? BTNS[e.button] : e.button;this.pointerId = e.pointerId || 0;this.absX = !isNaN(e.pageX) ? e.pageX : (e.clientX + DomE.scrollLeft - Body.clientLeft);this.absY = !isNaN(e.pageY) ? e.pageY : (e.clientY + DomE.scrollTop - Body.clientTop);this.eventXY = function () {return {x:this.absX, y:this.absY};};}this.srcElement = e.srcElement || e.target;};var _initJsvmEvent = function (type, data, source, canBubble) {this._type = type;this._data = data;this._source = source;this._bubble = (canBubble === undefined) || canBubble;};thi$._init = function (type, data, source, canBubble) {if (arguments.length === 0) {return;}if (!Class.isString(type)) {_initRealEvent.call(this, type || self.event);} else {_initJsvmEvent.apply(this, arguments);}this._default = true;this._time = new Date();};this._init.apply(this, arguments);}.$extend(js.lang.Object);(function () {var CLASS = this, Class = js.lang.Class, agents = {};var hash = function (obj) {return obj ? Math.hash(obj) : 0;};var uuid = function (e, t, f, o) {return [t, hash(e), hash(f), hash(o)].join("");};this.attachEvent = function (ele, type, fn, listener, args) {var id = uuid(ele, type, fn, listener), agent;if (agents[id]) {return;}args = Class.sliceArgs(arguments, 4);agent = agents[id] = function () {return function (e) {fn.apply(listener, [new CLASS(e)].concat(args));};}();if (ele.addEventListener) {ele.addEventListener(type, agent, false);} else {ele.attachEvent(["on", type].join(""), agent);}};this.detachEvent = function (ele, type, fn, listener) {var id = uuid(ele, type, fn, listener), agent;if (!(agent = agents[id])) {return;}if (ele.removeEventListener) {ele.removeEventListener(type, agent, false);} else {ele.detachEvent(["on", type].join(""), agent);}delete agents[id];};this.J$VM_MSG = "-j$vm-message";this.J$VM_HANDSHAKE = "-j$vm-handshake";this.J$VM_RESIZE = "-j$vm-resize";}).call(js.util.Event);

$package("js.net");js.net.HttpConnection = function () {var CLASS = js.net.HttpConnection, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.net.HttpConnection";var Class = js.lang.Class, System = J$VM.System, PV = {progids:["MSXML2.XMLHTTP.6.0", "MSXML2.XMLHTTP", "Microsoft.XMLHTTP"]};thi$.contentType = function () {var xhr = this.xhr;return xhr ? xhr.contentType || this.getResponseHeader("Content-Type") : null;};thi$.getResponseHeader = function (key) {var xhr = this.xhr;return xhr ? xhr.getResponseHeader(key) : null;};thi$.response = function () {var xhr = this.xhr;return xhr ? xhr.response : null;};thi$.responseText = function () {var xhr = this.xhr;return xhr ? xhr.responseText : null;};thi$.responseXML = function () {var xhr = this.xhr;return xhr ? xhr.responseXML : null;};thi$.responseJSON = function () {var text = this.responseText(), json = null;if (text) {try {json = JSON.parse(text);}catch (x) {}}return json;};thi$.status = function () {var xhr = this.xhr;return xhr ? xhr.status : -1;};thi$.statusText = function () {var xhr = this.xhr;return xhr ? xhr.statusText : "";};thi$.open = function (method, url, params, options, success, error) {System.updateLastAccessTime();var xhr = this.xhr, query = makeQueryString(params), timeout, sync;options = options || {};timeout = options.timeout || System.getProperty("j$vm_http_timeout", 6000000);sync = options.sync;if (!sync) {xhr.onreadystatechange = stateChanged.$bind(this, xhr, success, error);}_starTimer.$delay(timeout, this, xhr, error);xhr.open(method, url, !sync);xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");query = query.join("");if (sync) {xhr.send(query);} else {(function () {xhr.send(query);}).$delay(0);}};var stateChanged = function (e, xhr, success, error) {if (xhr.isTimeout || !J$VM) {return;}success = success || this.onsuccess;error = error || this.onerror;switch (xhr.readyState) {case 2:case 3:var status = 200;try {status = xhr.status;}catch (x) {}if (status != 200 && status != 304) {_stopTimer.call(this, xhr);if (Class.isFunction(error)) {error.call(this, this);}this.close();}break;case 4:_stopTimer.call(this, xhr);switch (xhr.status) {case 200:case 304:if (Class.isFunction(success)) {success.call(this, this);}this.close();break;default:if (Class.isFunction(error)) {error.call(this, this);}this.close();}break;}};thi$.close = function () {_stopTimer.call(this, this.xhr);this.xhr = null;};var _starTimer = function (xhr, error) {xhr.abort();xhr.isTimeout = true;error = error || this.onerror;if (Class.isFunction(error)) {error.call(this, this);}};var _stopTimer = function (xhr) {_starTimer.$cancel();xhr.isTimeout = null;};var makeQueryString = function (params) {var ret = [];if (!Class.isObject(params)) {return ret;}(function (v, k) {ret.push(k, "=", v, "&");}).$forEach(params);ret.push("__=", J$VM.__version__);return ret;};var createXHR = function () {var xhr;if (self.XMLHttpRequest) {xhr = new XMLHttpRequest();} else {if (PV.progid) {xhr = new ActiveObject(PV.progid);} else {(function (v) {try {xhr = new ActiveObject(v);PV.progid = v;throw Class.BREAKLOOP;}catch (x) {}}).$forEach(PV.progids);}}return xhr;};thi$._init = function () {this.xhr = createXHR();};this._init.apply(this, arguments);};

$package("js.net");js.net.URI = function () {var CLASS = js.net.URI, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.net.URI";var Class = js.lang.Class, keys = ["protocol", "username", "password", "hostname", "port", "path", "query", "fragment", "origin"];thi$.uriPath = function () {return [this.protocol, this.protocol ? "//" : null, this.username, this.password ? ":" : null, this.password, this.username ? "@" : null, this.hostname, this.port ? ":" : null, this.port, this.path].join("");};thi$.toString = function () {return [this.uriPath(), this.file, this.query, this.fragment].join("");};var _assign = function (v, i) {this[keys[i]] = v;};thi$._init = function () {if (arguments.length === 0) {return;}_assign.$forEach(Class.sliceArgs(arguments), this);var path = this.path;if (path) {var p = path.lastIndexOf("/");if (p != -1) {this.file = path.substring(p + 1);this.path = path.substring(0, p + 1);}}if (this.query) {this.params = CLASS.parseParams(this.query.substring(1));}};this._init.apply(this, arguments);};(function () {var A = self.document ? document.createElement("A") : {}, Class = js.lang.Class, URI = this;this.parse = function (uri) {if (!uri) {return null;}A.href = decodeURI(uri);return new URI(A.protocol, A.username, A.password, A.hostname, A.port, A.pathname, A.search, A.hash, A.href);};this.parseParams = function (query) {var params = {};if (query) {query = query.split("&");_split.$forEach(query, params);}return params;};var _split = function (v) {v = v.trim().split("=");if (v.length === 2) {this[v[0].trim()] = v[1].trim();}};this.makeURIString = function (parent, path) {A.href = Class.sliceArgs(arguments).join("");return A.href;};}).call(js.net.URI);

$package("js.util");js.util.Storage = function () {var Class = js.lang.Class, MemoryStorage = js.util.MemoryStorage;this.setItem = function (key, value) {this.removeItem(key);if (!(this instanceof MemoryStorage)) {switch (Class.typeOf(value)) {case "Object":case "Array":value = JSON.stringify(value);break;}$super(this, key, value);} else {$super(this);}}.$override(this.setItem);this.getItem = function (key) {var value = $super(this);try {value = JSON.parse(value);}catch (x) {}return value;}.$override(this.getItem);return this;};js.util.MemoryStorage = function (capacity) {var CLASS = js.util.MemoryStorage, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.util.MemoryStorage";var Class = js.lang.Class;thi$.setItem = function (key, value) {if (this.length >= this.capacity) {_reduce.call(this);}var map = this._vals, keys = this._keys;if (!Class.hasKey(map, key)) {keys.push(key);}map[key] = {key:key, count:1, data:value};this.length = keys.length;};thi$.getItem = function (key) {var map = this._vals, keys = this._keys, ele = map[key], ret;if (ele) {ele.count++;ret = ele.data;}return ret;};thi$.removeItem = function (key) {var map = this._vals, keys = this._keys, ele = map[key], ret;if (ele) {delete map[key];(function (v, i) {if (v === key) {keys.splice(i, 1);throw Class.BREAKLOOP;}}).$forEach(keys);this.length = keys.length;}return ret;};thi$.keys = function () {return this._keys;};thi$.key = function (index) {return this._keys[index];};thi$.clear = function () {this._keys = [];this._vals = {};this.length = 0;};var _reduce = function () {var array = Class.valuesOf(this._vals).sort(function (a, b) {return a.count - b.count;}), len = Math.floor(this.capacity / 10), tmp;len = len < 1 ? 1 : len;while (len > 0) {tmp = array.shift();this.removeItem(tmp.key);len--;}};thi$._init = function (capacity) {this.capacity = Class.isNumber(capacity) ? capacity : 1024;this.clear();};this._init.apply(this, arguments);}.$extend(js.lang.Object);(function () {var _local, _session, _memory, _cache;this.local = function () {return _local ? _local : (_local = this.call(self.localStorage));};this.session = function () {return _session ? _session : (_session = this.call(self.sessionStorage));};this.memory = function () {return _memory ? _memory : (_memory = this.call(new js.util.MemoryStorage()));};this.classCache = function () {var storage = this;return _cache ? _cache : new (function () {storage.local();storage.session();storage.memory();this.setItem = function (key, value) {try {_local.setItem(key, value);}catch (ex1) {try {_session.setItem(key, value);}catch (ex2) {_memory.setItem(key, value);}}};this.getItem = function (key) {var value = _memory.getItem(key);if (!value) {value = _session.getItem(key);if (!value) {value = _local.getItem(key);}}return value;};})();};}).call(js.util.Storage);

$package("js.lang");js.lang.System = J$VM = function (env) {var CLASS = js.lang.System, thi$ = CLASS.prototype;if (CLASS.__defined__) {this._init.apply(this, arguments);return;}CLASS.__defined__ = "js.lang.System";var Class = js.lang.Class, System = this, Event = js.util.Event, URI = js.net.URI, isworker, os, props;thi$.out = {println:function (s) {os.info(s);}};thi$.err = {println:function (s) {os.error(s);}};thi$.log = {println:function (s) {if (this.logEnabled()) {os.log(s);}}};thi$.logEnabled = function () {return this.getProperty("j$vm_log") === true;};thi$.enableLogger = function (b) {b = (b === undefined) || b;this.setProperty("j$vm_log", b);J$VM.sessnStorage.setItem("j$vm_log", b);return ["J$VM logger enabled is ", b].join("");};thi$.hasProperty = function (key) {return Class.hasKey(props, key);};thi$.getProperty = function (key, defValue) {return this.hasProperty(key) ? props[key] || defValue : defValue;};thi$.setProperty = function (key, value) {var pre = null;if (key) {pre = props[key];props[key] = value;}return pre;};thi$.objectCopy = function (src, des, deep, unmerge) {switch (Class.typeOf(src)) {case "Object":des = des || {};Math.forObject(src, function (v, k) {des[k] = (!deep || !Class.isObject(v)) ? v : this.objectCopy(v, (unmerge ? null : des[k]), deep, unmerge);}, this);break;case "Array":des = this.arrayCopy(src, 0, des, 0, src.length, deep);break;default:des = src;}return des;};thi$.arrayCopy = function (src, srcIdx, des, desIdx, length, deep) {var len = src.length - srcIdx;length = Class.isNumber(length) ? ((length > len) ? len : length) : len;des = des || [];Math.forArray(src, function (v, i) {if (i < srcIdx) {return;}if (i > srcIdx + length - 1) {throw Class.BREAKLOOP;}des[desIdx + i - srcIdx] = (!deep || !Class.isObject(v)) ? v : this.objectCopy(v, null, deep);}, this);return des;};var _onload = function (e) {System.out.println([J$VM.__product__, J$VM.__version__, "loading..."].join(" "));var U = this.__local__;saveUSize(U);if (self !== self.parent) {System.out.println("Handshake with outer J$VM.");this.postMessage(Event.J$VM_HANDSHAKE, null, null, self.parent);}};var _unload = function (e) {Event.detachEvent(self, "message", _onmessage, this);if (!isworker) {Event.attachEvent(self, "load", _onload, this);Event.attachEvent(self, "unload", _unload, this);Event.attachEvent(self, "resize", _resize, this);self.document.innerHTML = "";}System.out.println([J$VM.__product__, "unload."].join(" "));};var _resize = function (e) {var U = this.__local__;if (self.innerWidth != U.userW || self.innerHeight || U.userH) {saveUSize(U);e.setType(Event.J$VM_RESIZE);e.setData({width:U.userW, height:U.userH});this.dispatchEvent(e);}};var saveUSize = function (U) {U.userW = self.innerWidth;U.userH = self.innerHeight;};var _onmessage = function (e) {var _e = e._event, msg;if (self === _e.source) {return;}try {msg = JSON.parse(_e.data);}catch (x) {return;}if (Class.isArray(msg) && msg[0] === Event.J$VM_MSG) {msg = msg[1];e.setType(msg.type);e.setData(msg.data);this.dispatchEvent(e);}};var _onhandshake = function (e) {var source = e._event.source, ele;if (source !== self.parent) {ele = source.frameElement;ele.id = Math.uuid(ele);ele.setAttribute("jsvm_embedded", "true");System.out.println("Handshake with inner J$VM " + ele.id);this.postMessage(Event.J$VM_HANDSHAKE, null, null, ele.id);} else {this.isEmbedded = true;System.out.println("This J$VM is embedded.");}};var _initWorker = function () {os = new function () {var type = Event.J$VM_MSG, post = self.postMessage, msg = function (t, s) {return JSON.stringify([type, {type:t, data:s}]);};this.info = function (s) {post(msg("-j$vm-inf", s));};this.error = function (s) {post(msg("-j$vm-err", s));};this.log = function (s) {post(msg("-j$vm-log", s));};}();var A = self.location, uri, crs;uri = props.j$vm_uri = new URI(A.protocol, A.username, A.password, A.hostname, A.port, A.pathname, A.search, A.hash, A.href);crs = props.j$vm_crs = "../../../";props.j$vm_home = [uri.uriPath(), crs].join("");props.j$vm_classpath = [""];};var _initBrowser = function () {os = self.console || {info:function (s) {}, error:function (s) {}, log:function (s) {}};var stag = document.getElementById("j$vm"), uri, crs, cp;if (stag) {uri = props.j$vm_uri = URI.parse(stag.src || stag.getAttribute("crs"));crs = props.j$vm_crs = stag.getAttribute("crs");props.j$vm_home = crs.startsWith("http") ? crs : URI.makeURIString(uri.uriPath(), crs);cp = stag.getAttribute("classpath");props.j$vm_classpath = cp ? cp.split(";") : [""];}var storage = js.util.Storage;J$VM.localStorage = storage.local();J$VM.sessnStorage = storage.session();J$VM.classesCache = storage.classCache();System.enableLogger(J$VM.sessnStorage.getItem("j$vm_log") || false);J$VM.enableLogger = function () {return System.enableLogger(true);};J$VM.disableLogger = function () {return System.enableLogger(false);};Event.attachEvent(self, "load", _onload, this);Event.attachEvent(self, "unload", _unload, this);Event.attachEvent(self, "resize", _resize, this);Event.attachEvent(self, "message", _onmessage, this);this.attachEvent(Event.J$VM_HANDSHAKE, _onhandshake);};thi$._init = function (env) {if (J$VM.System) {return;}$super(this, {uuid:"__system__"});self.__uuid__ = this.uuid();props = env || {};if ((J$VM.isworker = !(self.document))) {_initWorker.call(this);} else {_initBrowser.call(this);}}.$override(this._init);this._init.apply(this, arguments);}.$extend(js.util.EventTarget);(function () {this.__product__ = "J$VM";this.__version__ = "1.0.";this.env = {};this.System = new js.lang.System(this.env);}).call(J$VM);

